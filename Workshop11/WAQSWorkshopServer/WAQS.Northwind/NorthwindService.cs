//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated from a template.
//     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
// Copyright (c) Matthieu MEZIL.  All rights reserved.
// matthieu.mezil@live.fr

 
using System;
using System.Collections;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Reflection;
using System.Threading.Tasks;
using System.Transactions;
using WAQS.Common;
using WAQS.DAL.Interfaces;
using WAQS.Entities;
using WAQS.SerializableExpressions;
using WAQS.Service;
using WAQS.Service.Interfaces;
using WAQSWorkshopServer;
using WAQSWorkshopServer.DAL.Interfaces;
using WAQSWorkshopServer.Service;
using WAQSWorkshopServer.Service.Interfaces;
using WAQSWorkshopServer.WAQSDTO;

namespace WAQSWorkshopServer.Service
{
    public abstract partial class NorthwindService : ServiceBase, INorthwindService, IDisposable
    {
        private Func<NorthwindService> _serviceFactory;
        private Func<INorthwindEntities> _contextFactory;
    
        static NorthwindService()
        {
            WAQSQuery.WithTypes.Add(typeof(Customer), new WithType
                {
                    Type = typeof(WithCustomer),
                    TransformToOriginalType = e =>
                    {
                        var withCustomer = e as WithCustomer;
                        if (withCustomer == null)
                            return e;
                        var value = withCustomer.Customer;
                        value.Specifications = withCustomer.Specifications;
                        return value;
                    }
                });
            WAQSQuery.WithTypes.Add(typeof(Employee), new WithType
                {
                    Type = typeof(WithEmployee),
                    TransformToOriginalType = e =>
                    {
                        var withEmployee = e as WithEmployee;
                        if (withEmployee == null)
                            return e;
                        var value = withEmployee.Employee;
                        value.Specifications = withEmployee.Specifications;
                        return value;
                    }
                });
            WAQSQuery.WithTypes.Add(typeof(InvoiceDetail), new WithType
                {
                    Type = typeof(WithInvoiceDetail),
                    TransformToOriginalType = e =>
                    {
                        var withInvoiceDetail = e as WithInvoiceDetail;
                        if (withInvoiceDetail == null)
                            return e;
                        var value = withInvoiceDetail.InvoiceDetail;
                        return value;
                    }
                });
            WAQSQuery.WithTypes.Add(typeof(Invoice), new WithType
                {
                    Type = typeof(WithInvoice),
                    TransformToOriginalType = e =>
                    {
                        var withInvoice = e as WithInvoice;
                        if (withInvoice == null)
                            return e;
                        var value = withInvoice.Invoice;
                        return value;
                    }
                });
            WAQSQuery.WithTypes.Add(typeof(OrderDetail), new WithType
                {
                    Type = typeof(WithOrderDetail),
                    TransformToOriginalType = e =>
                    {
                        var withOrderDetail = e as WithOrderDetail;
                        if (withOrderDetail == null)
                            return e;
                        var value = withOrderDetail.OrderDetail;
                        value.Specifications = withOrderDetail.Specifications;
                        return value;
                    }
                });
            WAQSQuery.WithTypes.Add(typeof(Order), new WithType
                {
                    Type = typeof(WithOrder),
                    TransformToOriginalType = e =>
                    {
                        var withOrder = e as WithOrder;
                        if (withOrder == null)
                            return e;
                        var value = withOrder.Order;
                        value.Specifications = withOrder.Specifications;
                        return value;
                    }
                });
            WAQSQuery.WithTypes.Add(typeof(Product), new WithType
                {
                    Type = typeof(WithProduct),
                    TransformToOriginalType = e =>
                    {
                        var withProduct = e as WithProduct;
                        if (withProduct == null)
                            return e;
                        var value = withProduct.Product;
                        value.Specifications = withProduct.Specifications;
                        return value;
                    }
                });
            WAQSQuery.WithTypes.Add(typeof(Category), new WithType
                {
                    Type = typeof(WithCategory),
                    TransformToOriginalType = e =>
                    {
                        var withCategory = e as WithCategory;
                        if (withCategory == null)
                            return e;
                        var value = withCategory.Category;
                        return value;
                    }
                });
        }
    
        public static void Init()
        {
            InitPartial();
        }
    
        static partial void InitPartial();
    
        public NorthwindService(Func<INorthwindEntities> contextFactory, Func<INorthwindEntities, ISerializableExpressionProvider> serializableExpressionProviderFactory, Func<NorthwindService> serviceFactory)
            : this(contextFactory(), serviceFactory)
        {
            _serializableExpressionProviderFactory = serializableExpressionProviderFactory;
        }
    
        public NorthwindService(Func<INorthwindEntities> contextFactory, Func<NorthwindService> serviceFactory)
            : this(contextFactory())
        {
            _contextFactory = contextFactory;
            _serviceFactory = serviceFactory;
        }
    
        public NorthwindService(INorthwindEntities context, Func<NorthwindService> serviceFactory)
            : this(() => context, serviceFactory)
        {
        }
    
        public NorthwindService(INorthwindEntities context)
        {
            _context = context;
            TrackableCollectionExtensions.AttachAction = (e1, e2, name) => _context.AttachRelationship(e1, e2, name);
            WAQSWorkshopServer.EntitiesOtherSpecifications.AddInvoiceFunc = AddInvoice;
            WAQSWorkshopServer.EntitiesOtherSpecifications.GetLastOrderFunc = GetLastOrder;
        }
    
        private readonly INorthwindEntities _context;
        protected INorthwindEntities Context
        {
            get { return _context; }
        }
    
    
        private readonly Func<INorthwindEntities, ISerializableExpressionProvider> _serializableExpressionProviderFactory;
        protected Func<INorthwindEntities, ISerializableExpressionProvider> SerializableExpressionProvider
        {
            get { return _serializableExpressionProviderFactory; }
        }
    
        protected override Func<ISerializableExpressionProvider> SerializableExpressionProviderFactory
        {
            get { return () => _serializableExpressionProviderFactory(_context); }
        }
    
        internal static object GetWithBaseObject(object obj)
        {
            var type = obj.GetType().BaseType;
            if (type == null)
                return obj;
            WithType withType;
            if (WAQSQuery.WithTypes.TryGetValue(type, out withType))
                return withType.TransformToOriginalType(obj);
            return obj;
        }
    
        public IEntitySet<WAQSWorkshopServer.Customer> Customers 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.Customers; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.Customer entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.Customers, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.Customer entity);
    
        public IEntitySet<WAQSWorkshopServer.Employee> Employees 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.Employees; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.Employee entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.Employees, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.Employee entity);
    
        public IEntitySet<WAQSWorkshopServer.InvoiceDetail> InvoiceDetails 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.InvoiceDetails; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.InvoiceDetail entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.InvoiceDetails, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.InvoiceDetail entity);
    
        public IEntitySet<WAQSWorkshopServer.Invoice> Invoices 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.Invoices; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.Invoice entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.Invoices, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.Invoice entity);
    
        public IEntitySet<WAQSWorkshopServer.OrderDetail> OrderDetails 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.OrderDetails; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.OrderDetail entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.OrderDetails, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.OrderDetail entity);
    
        public IEntitySet<WAQSWorkshopServer.Order> Orders 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.Orders; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.Order entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.Orders, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.Order entity);
    
        public IEntitySet<WAQSWorkshopServer.Product> Products 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.Products; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.Product entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.Products, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.Product entity);
    
        public IEntitySet<WAQSWorkshopServer.Category> Categories 
        { 
            get 
            {
                _context.UseWAQSProvider = true; 
                return _context.Categories; 
            } 
        }
    
        public void ApplyChanges(WAQSWorkshopServer.Category entity)
        {
            ApplyingChanges(ref entity);
            _context.ApplyChanges(_context.Categories, entity);
        }
    
        partial void ApplyingChanges(ref WAQSWorkshopServer.Category entity);
    
    
        public NorthwindQueryResult Execute(QuerySerialization query)
        {
            var expression = _serializableExpressionProviderFactory(_context).ToExpression(query.Expression, query.WithSpecificationsProperties);
            object result;
            try
            {
                result = Expression.Lambda(expression).Compile().DynamicInvoke();
            }
            catch (Exception e)
            {
                if (e.InnerException != null)
                    throw e.InnerException;
                else
                    throw e;
            }
            NorthwindQueryResult queryResult = new NorthwindQueryResult();
            bool onlyOne = false;
            var methodCallExpression = expression as MethodCallExpression;
            if (methodCallExpression != null)
                switch (methodCallExpression.Method.Name)
                {
                    case "First":
                    case "FirstOrDefault":
                    case "Single":
                    case "SingleOrDefault":
                    case "Last":
                    case "LastOrDefault":
                        onlyOne = true;
                        break;
                }
            bool manyResult = HasManyResult(expression.Type) && ! onlyOne;
            Type queryType = manyResult ? GetGenericType(expression.Type) : expression.Type;
            Type queryTypeLoop = queryType;
            int genericIndex = 0;
            while (queryTypeLoop.IsGenericType && queryTypeLoop.GetGenericTypeDefinition() == typeof(IEnumerable<>))
            {
                genericIndex++;
                queryTypeLoop = queryTypeLoop.GetGenericArguments()[0];
            }
            if (manyResult)
            {
                if (query.SerializableType.IsKnownByServer && genericIndex == 0)
                    queryResult.Values = typeof(NorthwindService).GetMethod("GetBaseTypeToArray", BindingFlags.Static | BindingFlags.NonPublic).MakeGenericMethod(NorthwindSerializableExpressionConverter.GetNorthwindBaseType(queryType) ?? queryType).Invoke(null, new object[] { result });
                else
                    queryResult.Records = ((IEnumerable)result).Cast<object>().Select(o => GetQueryResult(queryType, o)).ToList();
            }
            else
            {
                if (query.SerializableType.IsKnownByServer && genericIndex < 2)
                {
                    object value = result;
                    switch (genericIndex)
                    {
                        case 0:
                            queryResult.Value = NorthwindSerializableExpressionConverter.GetNorthwindBaseObject(value);
                            break;
                        case 1:
                            queryResult.Value = typeof(NorthwindService).GetMethod("GetBaseTypeToArray", BindingFlags.Static | BindingFlags.NonPublic).MakeGenericMethod(NorthwindSerializableExpressionConverter.GetNorthwindBaseType(queryTypeLoop) ?? queryTypeLoop).Invoke(null, new object[] { value });
                            break;
                    }
                }
                else
                    queryResult.Record = GetQueryResult(queryType, result);
            }
            return queryResult;
        }
    
        private static T[] GetBaseTypeToArray<T>(IEnumerable values)
        {
            if (values == null)
                return new T[0];
            return values.Cast<object>().Select(o => NorthwindSerializableExpressionConverter.GetNorthwindBaseObject(o)).Cast<T>().ToArray();
        }
    
        public NorthwindQueriesResult ExecuteMany(QueriesSerialization queries)
        {
            List<Task> tasks = new List<Task>();
            var result = ExecuteMany(queries, tasks);
            foreach (var task in tasks)
            {
                task.Wait();
                if (task.Exception != null)
                    throw task.Exception;
            }
            return result;
        }
        private NorthwindQueriesResult ExecuteMany(QueriesSerialization queries, List<Task> tasks)
        {
            var result = new NorthwindQueriesResult { QueryResults = new NorthwindQueryResult[queries.QuerySerializations.Length] };
            for (int queryIndex = 0 ; queryIndex < queries.QuerySerializations.Length ; queryIndex ++)
            {
                var query = queries.QuerySerializations[queryIndex];
                var indexLoop = queryIndex;
                tasks.Add(Task.Factory.StartNew(() =>
                    {
                        using (var service = _serviceFactory())
                        {
                            result.QueryResults[indexLoop] = service.Execute(query);
                        }
                    }));
            }
            return result;
        }
    
        public abstract NorthwindQueryResultPage LoadPage(int pageSize, SerializableExpression queryExpression, IEnumerable<string> withSpecificationsProperties, LoadPageParameter[] identifiers);
            
        private static ConcurrentDictionary<Type, Lazy<WeakReference>> _queryResultRecordFactories = new ConcurrentDictionary<Type, Lazy<WeakReference>>(); 
        protected QueryResultRecord GetQueryResult(Type type, object o)
        {
            if (o == null)
                return null;
            for (;;)
            {
                WeakReference weakReference = _queryResultRecordFactories.GetOrAdd(type, new Lazy<WeakReference>(() => new WeakReference(CreateQueryResultExpression(type, _serializableExpressionProviderFactory(_context).GetOriginalType(type)).Compile()))).Value;
                var queryResultRecordFactory = (Func<object, QueryResultRecord>)weakReference.Target;
                if (queryResultRecordFactory != null)
                    return queryResultRecordFactory(o);
                Lazy<WeakReference> dummy;
                _queryResultRecordFactories.TryRemove(type, out dummy);
            }
        }
    
        public DateTime GetDbDateTime()
        {
            return _context.GetDbDateTime();
        }
    
        public void SaveChanges()
        {
            bool saved = false;
            SaveChanges(ref saved);
            if (! saved)
            {
                var errors = new List<Error>();
                foreach (var e in _context.Customers.Local)
                    errors.AddRange(e.ValidateOutTransaction(true).Where(er => er != null && (er.Criticity & Criticity.Error) != 0));
                foreach (var e in _context.OrderDetails.Local)
                    errors.AddRange(e.ValidateOutTransaction(true).Where(er => er != null && (er.Criticity & Criticity.Error) != 0));
                foreach (var e in _context.Orders.Local)
                    errors.AddRange(e.ValidateOutTransaction(true).Where(er => er != null && (er.Criticity & Criticity.Error) != 0));
                if (errors.Count != 0)
                    throw new ValidationException(errors);
                using (var transaction = new TransactionScope())
                {
                    var getErrorsInTransaction = new List<Func<IEnumerable<Error>>>();	
                    var getErrorInTransaction = OrderDetailDependencesErrors();
                    if (getErrorInTransaction != null)
                        getErrorsInTransaction.Add(getErrorInTransaction);
                    _context.SaveChanges();
                    foreach (var er in getErrorsInTransaction.SelectMany(getErrors => getErrors()).Where(e => e != null))
                        errors.Add(er);
                    if (errors.Count == 0)
                        transaction.Complete();
                }
                if (errors.Count != 0)
                    throw new ValidationException(errors);
            }
        }
    
        partial void SaveChanges(ref bool saved);
    
        private Func<IEnumerable<Error>> OrderDetailDependencesErrors()
        {
            var orderDetailsModified = _context.OrderDetails.Local.OfType<OrderDetail>().Where(e => e.ChangeTracker.State == ObjectState.Modified && (e.ChangeTracker.ModifiedProperties.Contains("OrderId"))).ToList();
            var orderDetails = orderDetailsModified.Union(_context.OrderDetails.Local.OfType<OrderDetail>().Where(e => e.ChangeTracker.State == ObjectState.Deleted)).ToList();
            var addedOrderDetails = _context.OrderDetails.Local.OfType<OrderDetail>().Where(e => e.ChangeTracker.State == ObjectState.Added).ToList();
            var orderDetailsIds = new OrderDetail[0].Select(e => new { e.Id, e.OrderId });
            if (orderDetails.Count == 0)
            {
                if (addedOrderDetails.Count == 0)
                    return null;
            }
            else
            {
                var orderDetailsPredicateBeforeTransactionParameter = Expression.Parameter(typeof(OrderDetail));
                var orderDetailsPredicateBeforeTransaction = Expression.Lambda<Func<OrderDetail, bool>>(orderDetails.Select(e =>
                {
                    int id = e.Id;
                    Expression<Func<int>> getIdExp = () => id;
                    return Expression.Equal(Expression.MakeMemberAccess(orderDetailsPredicateBeforeTransactionParameter, typeof(OrderDetail).GetProperty("Id")), getIdExp.Body);
                }).Aggregate((e1, e2) => Expression.Or(e1, e2)), orderDetailsPredicateBeforeTransactionParameter);
                orderDetailsIds = _context.OrderDetails.OfType<OrderDetail>().Where(orderDetailsPredicateBeforeTransaction).Select(e => new { e.Id, e.OrderId }).ToList(); 
            }
            return () => 
            {
                var errors = new List<Error>();
     
                var orderDetailOrderIds = orderDetailsIds.Select(e => e.OrderId).Union(addedOrderDetails.Select(e => e.OrderId)); 
                var includeOrderNewOrderDetail = orderDetails.Where(e => e.ChangeTracker.State == ObjectState.Modified && (e.ChangeTracker.ModifiedProperties.Contains("OrderId") ));
                UseModifiedOrder(ref includeOrderNewOrderDetail);
                if (includeOrderNewOrderDetail != null)
                    orderDetailOrderIds = orderDetailOrderIds.Union(includeOrderNewOrderDetail.Select(e => e.OrderId)).Distinct();
                orderDetailOrderIds = orderDetailOrderIds.Distinct();
                var ordersPredicateAfterTransactionParameter = Expression.Parameter(typeof(Order));
                var ordersPredicateAfterTransaction = Expression.Lambda<Func<Order, bool>>(orderDetailOrderIds.Select(idValue => 
                {
                    int orderId = idValue;
                    Expression<Func<int>> getOrderIdExp = () => orderId;
                    return Expression.Equal(Expression.MakeMemberAccess(ordersPredicateAfterTransactionParameter, typeof(Order).GetProperty("Id")), getOrderIdExp.Body);
                }).Aggregate((e1, e2) => Expression.Or(e1, e2)), ordersPredicateAfterTransactionParameter);
    
                var ordersSelectParameter = Expression.Parameter(typeof(Order));
                var ordersMemberBindings = new List<MemberBinding>();
                ordersMemberBindings.Add(Expression.Bind(typeof(OrderDetail_Order_Validations).GetProperty("Id"), Expression.MakeMemberAccess(ordersSelectParameter, typeof(Order).GetProperty("Id"))));
                var validateValidateOrderHasOrderLinesExpression = _context.OrderDALSpecifications.ValidateOrderHasOrderLinesExpressionCondition;
                ordersMemberBindings.Add(Expression.Bind(typeof(OrderDetail_Order_Validations).GetProperty("ValidateOrderHasOrderLines"), validateValidateOrderHasOrderLinesExpression.Body.ReplaceParameter(validateValidateOrderHasOrderLinesExpression.Parameters[0], ordersSelectParameter)));
                var ordersSelect = Expression.Lambda<Func<Order, OrderDetail_Order_Validations>>(Expression.MemberInit(Expression.New(typeof(OrderDetail_Order_Validations).GetConstructor(new Type[0])), ordersMemberBindings), ordersSelectParameter);
                foreach (var orderIdValues in _context.Orders.OfType<Order>().Where(ordersPredicateAfterTransaction).Select(ordersSelect))
                {
                    var order = _context.Orders.Local.OfType<Order>().FirstOrDefault(e => e.Id == orderIdValues.Id) ?? new Order { Id = orderIdValues.Id };
                    Error error;
                    if (orderIdValues.ValidateOrderHasOrderLines)
                    {
                        error = new Error { Criticity = Criticity.Error, Message = "Order must have detail" };
                        error.Key = "OrderHasOrderLines";
                        errors.Add(error);
                    }
                }
     
                return errors;
            };
        }
        partial void UseModifiedOrder(ref IEnumerable<OrderDetail> includeOrderNewOrderDetail);
    
        private class OrderDetail_Order_Validations
        {
            public int Id
            {
                get;
                set;
            }
        
            public bool ValidateOrderHasOrderLines
            {
                get;
                set;
            }
        }
        
    
        public IEnumerable<Error> Validate(Customer entity)
        {
            yield break;
        }
    
        public IEnumerable<Error> Validate(Employee entity)
        {
            yield break;
        }
    
        public IEnumerable<Error> Validate(InvoiceDetail entity)
        {
            yield break;
        }
    
        public IEnumerable<Error> Validate(Invoice entity)
        {
            yield break;
        }
    
        public IEnumerable<Error> Validate(OrderDetail entity)
        {
            yield break;
        }
    
        public IEnumerable<Error> Validate(Order entity)
        {
            yield break;
        }
    
        public IEnumerable<Error> Validate(Product entity)
        {
            yield break;
        }
    
        public IEnumerable<Error> Validate(Category entity)
        {
            yield break;
        }
     
        public bool AlreadySoldTo(Employee employee, Customer customer)
        {
            _context.UseWAQSProvider = true;
            return employee.AlreadySoldTo(customer);
        }
        public Invoice AddInvoice(int orderId)
        {
            var order = this.Orders.IncludeOrderDetails().WithCustomerCompanyName().WithCustomerContactName().FirstOrDefault(o => o.Id == orderId);
            if (order == null)
            {
                throw new ArgumentException("The is no order for this id", "orderId");
            }
        
            Invoice invoice = new Invoice
            {
            OrderId = order.Id, CustomerId = order.CustomerId, CustomerCompanyName = order.CustomerCompanyName, CustomerContactName = order.CustomerContactName, Total = order.Total
            }
        
            ;
            foreach (var od in order.OrderDetails)
            {
                invoice.InvoiceDetails.Add(od.CreateInvoiceDetail());
            }
        
            this.Invoices.Add(invoice);
            this.SaveChanges();
            return invoice;
        }
        public InvoiceDetail CreateInvoiceDetail(OrderDetail od)
        {
            _context.UseWAQSProvider = true;
            return od.CreateInvoiceDetail();
        }
        public LastOrderDTO GetLastOrder()
        {
            return (
                from o in this.Orders
                where o.EmployeeId.HasValue
                orderby o.OrderDate descending
                select new LastOrderDTO
                {
                OrderId = o.Id, EmployeeId = o.EmployeeId.Value, EmployeeFullName = o.Employee.FullName, Date = o.OrderDate, Total = o.Total
                }
        
            ).FirstOrDefault();
        }
    
        void IDisposable.Dispose()
        {
            _context.Dispose();
        }
    }
}
